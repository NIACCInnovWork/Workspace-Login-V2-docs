db_load utility
===============

This utility loads data from a database from a file generated by 
`mysqldump <https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html>`_. The main 
purpose of this utility is to handle the networking setup to reach the database.

.. warning::

   This utility will delete all tables in the target schema and does **not** 
   take a backup.  Use this utility with extream caution.

The database lives within the kubernetes cluster and is not publicly routable. 
This means the database restore needs to run in a container inside the cluster 
or the db needs to be exposed locally through the 
`kubectl port-forward <https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/>`_
command. 

This utility does the following operations:

 #. Setup port forwarding to the db service
 #. Fetch the db root password from the k8s secret store
 #. Establish a DB connection through the port forwarded proxy       
 #. Delete all existing tables
 #. Execute all statements in the supplied db import file
 #. Shutdown db connection and port forwarding

In order for these steps to work, kubectl needs to be installed and configured
on the machine on which the utility will run.  Additionally, the port 3306 
needs to be open for port-forwarding.

The utility expects 3 environment variables to be set before the application 
launches. These are:

+----------------------+------------------------------------------------------+
| Environment Variable | Description                                          |
+======================+======================================================+
| DB_SERVICE           | The k8s service at which the database is running     |
+----------------------+------------------------------------------------------+
| DB_SECRET            | The k8s secret name at which the root db password can|
|                      | be found. Note: this is NOT the root db password     |
|                      | itself.                                              |
+----------------------+------------------------------------------------------+
| DB_IMPORT_FILE       | The file location of the db dump file which is to be | 
|                      | restored.                                            |
+----------------------+------------------------------------------------------+

The utility is launched using the command `python -m ws_login_scripts.load_db`.
This will then display a final warning promped before continuing.  The prompt 
looks like the following:

.. code-block:: bash
   
  This utility will attempt to delete ALL existing data in the database and 
  load in the data from the specified file. This utility DOES NOT create 
  backups before proceeding.

  DB_SERVICE: ws-login-dev-db
  DB_SECRET: ws-login-dev-db
  DB_IMPORT_FILE: /home/****/Downloads/Dump20230126.sql

  Are you sure you want to proceed?  (Y/n):  


